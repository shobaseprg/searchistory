rules_version = '2';

service cloud.firestore {

  function isAuth(){
    return request.auth != null
  }
  function myUID(){
    return request.auth.uid
  }
  function incomingData(){
    return request.resource.data
  }
  function existingData(){
    return resource.data
  }
  function isAvailableCreateFields(fieldList){
    return incomingData().keys().hasOnly(fieldList)
  }
  function isAvailableUpdateFields(FieldList){
    return incomingData().diff(existingData()).affectedKeys().hasOnly(FieldList)
  }
  function getParentTopic(database,documentID){
    return get(/databases/$(database)/documents/topic/$(documentID))
  }
  match /databases/{database}/documents {
    match /user/{userID} {
      allow get:if isAuth()
      allow list:if true;
      allow create:if isAuth() &&
                      isAvailableCreateFields(["name","uid"]) &&
                      userID == myUID() &&
                      incomingData().name is string &&
                      incomingData().name.size() < 31 &&
                      incomingData().name.size() > 2 &&
                      incomingData().uid == myUID();
      allow update:if isAuth() &&
                      isAvailableUpdateFields(['name']) &&
                      userID == myUID() &&
                      incomingData().name is string &&
                      incomingData().name.size() < 31 &&
                      incomingData().name.size() > 2 ;
    }
    // userPrivate
    match /userPrivate/{userID} {
      allow get:if isAuth() &&
                    userID == myUID();
      allow create:if isAuth() &&
                      isAvailableCreateFields(["uid","memberUIDs"]) &&
                      userID == myUID() &&
                      incomingData().uid == myUID();
      allow update:if isAuth() &&
                      isAvailableUpdateFields(["memberUIDs"]) &&
                      userID == myUID();
    }
    // topic
    match /topic/{documentID} {
      allow get:if isAuth() &&
                    myUID() in existingData().authorizedUIDs;
      allow list:if isAuth() &&
                    myUID() in existingData().authorizedUIDs;
      allow create:if isAuth() &&
                      isAvailableCreateFields(["title","content","authorizedUIDs","files","createdAt","updatedAt","status","uid","docID","historyList"]) &&
                      incomingData().uid == myUID() &&
                      incomingData().title is string &&
                      incomingData().title.size() < 101 &&
                      incomingData().title.size() > 0 &&
                      incomingData().content is string &&
                      incomingData().content.size() < 10001 &&
                      incomingData().content.size() > 0 &&
                      incomingData().authorizedUIDs is list &&
                      myUID() in incomingData().authorizedUIDs &&
                      incomingData().files is list &&
                      incomingData().updatedAt is timestamp &&
                      incomingData().status == "pending" &&
                      incomingData().docID == documentID &&
                      incomingData().createdAt is timestamp &&
                      incomingData().historyList is list;
      allow update:if isAuth() &&
                      existingData().uid == myUID() &&
                      myUID() in incomingData().authorizedUIDs &&
                      isAvailableUpdateFields(["title","content","authorizedUIDs","files","updatedAt","status"]) &&
                      incomingData().title is string &&
                      incomingData().title.size() < 101 &&
                      incomingData().title.size() > 0 &&
                      incomingData().content is string &&
                      incomingData().content.size() < 10001 &&
                      incomingData().content.size() > 0 &&
                      incomingData().authorizedUIDs is list &&
                      myUID() in incomingData().authorizedUIDs &&
                      incomingData().files is list &&
                      incomingData().updatedAt is timestamp &&
                      incomingData().status is string;
      allow delete:if isAuth() &&
                      existingData().uid == myUID();
      // topic/history
      match /history/{historyDocumentID}{
        allow list:if isAuth() &&
                        myUID() in getParentTopic(database,documentID).data.authorizedUIDs
        allow create:if isAuth() &&
                        incomingData().uid == myUID() &&
                        myUID() in getParentTopic(database,documentID).data.authorizedUIDs &&
                        isAvailableCreateFields(["url","title","content","status","files","updatedAt","createdAt","docID","uid","topicDocID"]);
        allow update:if isAuth() &&
                        myUID() in getParentTopic(database,documentID).data.authorizedUIDs &&
                        isAvailableUpdateFields(["title","content","status","files","updatedAt"]);
        allow delete:if isAuth() &&
                        myUID() == getParentTopic(database,documentID).data.uid ||
                        myUID() == existingData().uid;
      }
    }
  }
}
